- job:
    name: Monasca-Single-Node
    project-type: freestyle
    description: Build a single node Monasca system and run tests against it.
    scm:
        - git:
            url: https://github.com/hpcloud-mon/monasca-ci
            name: origin
            skip-tag: true
            prune: true
            clean:
                before: true
            wipe-workspace: true
    triggers:
      - pollscm: "*/5 * * * *"
    builders:
        - copy-artifact:
            project_name: monasca-agent
        - copy-artifact:
            project_name: monasca-api
        - copy-artifact:
            project_name: monasca-notification
        - copy-artifact:
            project_name: monasca-persister
        - copy-artifact:
            project_name: monasca-thresh
        - copy-artifact:
            project_name: python-monascaclient
        - shell: |
            #!/bin/bash
            cd system
            ansible-playbook -i hosts -c local -e job_name=${JOB_NAME} -e build_number=${BUILD_NUMBER} docker_start.yml
            ansible-galaxy install -r requirements.yml -p ./single-node/roles -f
            cd single-node
            ansible-playbook -i hosts site.yml
    publishers:
        - postbuildscript:
            script-only-if-succeeded: False
            builders:
                - shell: |
                    #!/bin/bash
                    cd system
                    ansible-playbook -i hosts -c local -e job_name=${JOB_NAME} -e build_number=${BUILD_NUMBER} docker_stop.yml

# In the future take the inventory written by docker start and save as an artifact then I can use this to trigger more tests and move the stop
# to after all the test.
